# Настройка zabbix agent 2 active

Используемая версия zabbix agent2 5.0.29.
Используемая версия zabbix server 5.0 LST.

0. [Ссылка для скачивания zabbix агента](https://www.zabbix.com/download_agents).
1. Содержимое данного каталога:

    * *zabbix_agent2-5.0.29-windows-i386-static* - дистрибутив агента.
    * *zabbix_agent2.exe* - исполняемый файл агента из дистрибутива.
    * *zabbix_agent2.win.conf* - файл настройки агента.
    * *00_INSTALL_zabbix_agent2_as_windows_service.bat* - скрипт добавляет zabbix ageent 2 в службы Windows.
    * *01_UNINSTALL_zabbix_agent2_from_windows_service.bat* - скрипт удаляет zabbix agent 2 из служб Windows.
    * *02_START_zabbix_agent2_service.bat* - скрипт запуска zabbix агента.
    * *03_STOP_zabbix_agent2_service.bat* - скрипт остановки zabbix агента.
    * *FIREWALL_ADD_rules.bat* - добавляет правила в фаервол, для работы агента
    * *FIREWALL_DELETE_rules.bat* - удаляет ранее созданные, если существуют,правила работы агента

## Настройка фаервола

Выполним требуемые настройки фаервола запустив скрипт *FIREWALL_ADD_rules.bat*, после выполнения которого, создадутся требуемые правила для корректной работы агента и запустится фаервол(все профили, если был выключен.

## Настройка  автоматического обнаружения сервером zabbix узла сети, на котором установлен zabbix agent 2 активный

### Настройки на стороне zabbix сервера

Следует настроить действие по автоматической регистрации хостов в системе zabbix, при выполненнии определенных пользователем условий.

1. Настройки выполняются через web интерфейс пользователем с админ правами.
2. Перейдем по следуещему пути: **Настройки -> Действия -> Действия авторегистрации"**.
3. В правом верхнем углу экрана нажмем кнопку *Создать действие*.
4. На вкладке **Действие**:
    * поле **Имя**: ввести придуманное имя.
    * Поле **Условие**: нажмем **Добавить** и в появившемся окне выберем:
         * **Тип** = **Метаданные узлов сети**.
            Метаданными хоста является строка идентификатор,указанная пользователем на стороне zabbix агента в его файле настроек *zabbix_agent2.win.conf* в параметре **HostMetadata**.
         * **Оператор** = **Содержит**.
         * **Значение** = строка, указанная в параметра **HostMetadata** в файле настроек агента *zabbix_agent2.win.conf*
5. На вкладке *Операции* нажимаем *Добавить* для того, чтобы добавить отдельную операцию. Добавим следующие операции:
    * **Добавить узел сети**
    * **Добыввить в группу узлов сети**, выбрав в поле **Группы узлов сети** требуемые группы
    * **Присоеденить к шаблонам**, выбрав в поле **Шаблоны** требуемые шаблоны
6. Нажимаем кнопку **Добавить**, после чего в списке **Действия авторегистрации** появится вновь созданное действие.

### Настройка на сторне агента

0. Настроим фаервол, запустив скрипт *FIREWALL_ADD_rules.bat*(!!! После его испонения фаервол будет включен)
1. Отредактируем файл *zabbix_agent2.win.conf*

    ```al
    # IP zabbix сервера для пассивных проверок
    Server=

    # IP zabbix сервера для активных проверок
    ServerActive=

    # системное имя наблюдаемого узла сети
    # system.hostname - системное имя ПК
    # можно придуматьсвое имя(любая строка)
    # Данное имя будет присвоено хосту в zabbix
    HostnameItem=system.hostname

    # по данному параметру настраивается обнаружение узлов сети с активным агентом
    # он должен совпадать с тем, который указали в настройках сервера
    # (Настройки -> Действия -> Действия авторегистрации -> "Имя требуемого действия").
    HostMetadata=ekp

    # как часто агент будет обновлять с сервера список требуемых для мониторинга элементов данных
    #(в сукундах).
    RefreshActiveChecks=3600
    ```

2. Добавим zabbix agent 2 в службы Windows, запустив скрипт *00_INSTALL_zabbix_agent2_as_windows_service.bat*
3. Стартуем службу zabbix agent 2 штатными средствами Windows или запустив скрипт *02_START_zabbix_agent2_service.bat*
4. После !!!первого запуска!!! агента на данном ПК, zabbix сервер обнаружит наш хост, но данные с хоста еще не поступают!!! Для того чтобы данные начали передаваться агентом на сервер, следует пререзапустить службу *zabbix agent 2*.
5. Запустим скрипт добавляющий правила в локальный фаервол для работы агента.
