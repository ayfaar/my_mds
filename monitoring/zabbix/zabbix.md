# ZABBIX

## zabbix agent

Агенты бывают 2х видов:

+ **пассивный** - сервер обращается за данными к агенту.\
    zabbix-server --> zabbix-agent passive checks **10050/TCP**
+ **активный** - агент сам обращается к серверу и передает ему данные.
    zabbix-server **10051/TCP** <-- zabbix agent active checks

!! Агент может быть запущен сразу в 2х режимах
!!! В файле настроек агента есть параметр **Hostname**, он должен совпадать с именем хоста в web-интерфейсе zabbix.\
!!! Удаленные команды можно запускать только через пассивный агент.

### Пассивный агент

#### Принцип работы пассивного агента

Пассивный агент лучше использовать в том случае, когда требуется получить много итемов, которые долго обрабатываются(10 и боле секунд, и нет возможности совершить данную обработку вне агента, послав затем обработанные данные серверу через zabbix_sender)

У zabbix сервера есть внутренние процессы называемые **pollers**. Zabbix сервер при помощи **poller**а подключается к пассивному агенту по порту **10050/TCP** и запрашивает у агента данные, после чего ждет ответа. Агент обрабатывает запрос и передает данные **poller**у, после чего закрывает соединение.\
Время ожидания **poller**a настраивается параметром из файла zabbix_server.conf  **Timeout**(по возможности его лучше не увеличивать). В настройках агента также присутствует ключ **Timeout**, означает максимальное время выделенное агенту для получения запрашиваемых сервером данных.

Если запрашиваемые данные обрабатываются долго, то это может вызвать задержки в получении данных. Для того, чтобы можно было получать данные, в то время как агент занят обработкой других данных,т.е. увеличить количество параллельных проверок, то нужно увеличить количество свободных поллеров на стороне сервера(отвечает ключ **StartPollers**), если их не хватает, и увеличить количество форков процесса агента(ключ **StartAgents**), к каждому форку процесса может подключиться отдельный поллер.

Для активации пассивного агента в файле настроек агента укажем ключ, значением которого являются один или более(через запятую) IP адоессов zabbix серверов:

+ **Server=** 192.168.100.10,192.168.100.11

### Активный агент

!!! ВНИМАНИЕ.\
Если на разных хостах параметр агента **Hostname** одинаков, то хост в zabbix с данным именем будет получать значения айтемсов со всех этих хостов, что приводит к некорректности сбора данных.\
Для того, чтобы найти хосты с одинаковыми значениями параметра **Hostname**, следует в вебинтерфейсе zabbix переименовать хост, который получает данные с разных ПК, после чего перезагружаем zabbix сервер и в лог файле zabbix сервера увидим IP адреса хостов, агенты которых подключились к нашему zabbix серверу и пытаются найти на zabbix сервере хост с именем, указанном в **Hostname**

#### Принцип работы активного агента

Активный агент посылает на трапер порт сервера **10051/TCP**, запрос о том какие данные следует собирать агенту, после получения данной информации агент начинает пересылать данные серверу на порт **10051/TCP**.

За количество форков процесса трапера оивечает ключ **StartTrapers** в файле настроек сервера.

У активного агента имеется буфер для данных, если пропадет сеть, то данные не потеряются.

В отличие от пассивного агента, активный - имеет всего оди процесс и его нельзя форкнуть,как пассивный агент(ключ StartAgents), и если активному агенту требуется обработать часто и много данных, то может образоваться очередь, и следует задуматься над использованием пассивного агента.

Для активации активного агента следует указать ключи:

+ **ServerActive=**
    Один или более IP адресов(через запятую) zabbix серверов, куда слать данные.
+ **Hostname=**
    Имя хоста, должно совпадать с именм хоста в web-интерфейсе zabbix сервера.
+ **HostnameItem=system.hostname**
    Если не указан ключ **Hostname**, то используется ключь **HostnameItem**, значение которого по умолчанию является ключ *system.hostname*. Вместо значения данного ключа можно также подставлять **UserParameter**
+ Если не указан ни **Hostname**, ни **HostnameItem**, то берется системное имя хоста.

#### Авторегистрация активного агента (zabbix agent active autoregistration)

!!! Вниманее. Стоит обратить внимание на то, что хост в zabbix может иметь *элемент данных(item)* с уникальным названием ключа(*key item*), и если в действиях авторегистрации хост попадает под разеые действия, в которых подключаются разные шаблоны, следует избегать в этих шаблонах одинаковых названий ключей элементов данных, иначе к хосту применится только первое подходящее действие.
!!! Вниманее. По умолчанию автозарегестрированные хосты добавляются в группу *Discovery*, группу по умолчанию можно изменить в **Administration --> General --> Other**

Настройки на стороне сервера делаются пользователем с правами администратора.\
Для добавления действия авторегистрации прейдем в: **Configuration --> Actions --> Autoregistration actions**.\
После чего очистим кэш конфигурации сервера:

```bash
zabbix-server -R congig_cache_reload
```

На стороне агента нужно править следующие параметры в файле конфигурации:

+ **ServerActive**
    Один или более IP адресов(через запятую) zabbix серверов, куда агенту слать данные.
+ **Hostname**
    Если указан, то использовать его значение для именования хоста, который авторегестрируется.
+ **HostnameItem**
    Если не указан ключ **Hostname**, то используется ключь **HostnameItem**, значение которого по умолчанию является ключ *system.hostname*. Вместо значения данного ключа можно также подставлять **UserParameter**
+ **HostMetadata**
    Строка, благодоря которой можно идентифицировать хост
+ **HostMetadataItem**
    То же что и **Hostmetadata**, но в качестве значений можно использовать поддерживаемые агентом ключи и **UserParameter**

***

## User Parameters

Если в агенте не реализованы какий-либо функционал, то его можно реализовать при помощи **User Parameters**. Они пределяются в файле конфигурации агента(**zabbix_agentd.conf**) или же в файлах с прозвольным именем и расширением *.conf*, котрорые находятся в каталоге **/etc/zabbix/zabbix_agentd.d/**.

Синтаксис:

```properties
UserParametr=<key>,<command>
```

```properties
UserParametr=<key[*]>,<command $1 $2 $3>
```

где key - уникальное имя, которое будет использоваться при создании элемента данных;
    command - команда которая будет выполнена агентом

Пример 1:

```properties
UserParametr=echo_1,echo 1
```

Здесь мы определили user parametr, который всегда будет возвращать значение 1.

Пример 2(flexible user parametr):

```properties
UserParametr=flex_echo[*], echo $1 $2 $3
```

При конфигурации в элементе данных как flex_echo[1,2,45], вернет значение: 1,2,45

### Проверка добавленного user parametr

```bash
zabbix_agentd -t key[1st_par,2nd_par]
```

```bash
zabbix_get -s 127.0.0.1 -p 10050 -k key[1st_par,2nd_par]
```

## Разные команды

Количество запущенных траперов

```bash
ps ax | grep -E trapper #
```

Количество запущенных поллеров

```bash
ps ax | grep -E poller #1
```

Получить каколй-либо элемент данных от агента(в примере имя хоста):

```bash
zabbix_get -s 192.168.100.100 -p 10050 -k system.hostname
```
